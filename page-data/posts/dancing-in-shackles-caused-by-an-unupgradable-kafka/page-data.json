{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/dancing-in-shackles-caused-by-an-unupgradable-kafka/","result":{"data":{"markdownRemark":{"id":"5400c93a-996c-5aba-b77c-a138f0ffe421","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7e91be4d6ad8c98e2cbc65cf6ef97884/4b190/shackles-kafka-java.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMEAf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHbphKXqwmCos//xAAbEAACAwADAAAAAAAAAAAAAAABAgAQEQMSIv/aAAgBAQABBQJFKwnz1jaV4gaJyIa//8QAFhEAAwAAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/ASv/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAYEAADAQEAAAAAAAAAAAAAAAABEBEAMv/aAAgBAQAGPwLoxwaoP//EAB0QAQACAgIDAAAAAAAAAAAAAAEAESExEEFRcbH/2gAIAQEAAT8h3JbYJfW1fsF2l+oEoC9zoNYy74ZIj3Xl4//aAAwDAQACAAMAAAAQN+8B/8QAFhEBAQEAAAAAAAAAAAAAAAAAASBB/9oACAEDAQE/EA2H/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAgEBPxBia//EABwQAQADAQADAQAAAAAAAAAAAAEAESExQVGB8P/aAAgBAQABPxBpvSpBrebKYEHULXyUbctYNWtWanUYl0r6O/mVKQHfMes0KobpyLP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7e91be4d6ad8c98e2cbc65cf6ef97884/8ac56/shackles-kafka-java.webp 240w,\n/static/7e91be4d6ad8c98e2cbc65cf6ef97884/d3be9/shackles-kafka-java.webp 480w,\n/static/7e91be4d6ad8c98e2cbc65cf6ef97884/d00b9/shackles-kafka-java.webp 800w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7e91be4d6ad8c98e2cbc65cf6ef97884/09b79/shackles-kafka-java.jpg 240w,\n/static/7e91be4d6ad8c98e2cbc65cf6ef97884/7cc5e/shackles-kafka-java.jpg 480w,\n/static/7e91be4d6ad8c98e2cbc65cf6ef97884/4b190/shackles-kafka-java.jpg 800w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7e91be4d6ad8c98e2cbc65cf6ef97884/4b190/shackles-kafka-java.jpg\"\n            alt=\"shackles-kafka-java\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>This is a story about how to get a hack solution to work around a Kafka bug when its upgrade is blocked by the Java version and the official solution is not available.</p>\n<h2 id=\"root-cause\" style=\"position:relative;\"><a href=\"#root-cause\" aria-label=\"root cause permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Root Cause</h2>\n<p>The call of the <code class=\"language-text\">KafkaConsumer#poll</code> method may be blocked forever despite having a timeout parameter since that timeout only applies to the <code class=\"language-text\">ConsumerNetworkClient#poll</code> method and not the <code class=\"language-text\">ConsumerCoordinator#poll</code> method. It may trap in a loop inside the <code class=\"language-text\">ConsumerCoordinator#poll</code> method forever.</p>\n<h2 id=\"official-solution\" style=\"position:relative;\"><a href=\"#official-solution\" aria-label=\"official solution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Official Solution</h2>\n<p>The official team of Kafka has provided a solution to <a href=\"https://issues.apache.org/jira/browse/KAFKA-5697\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">this issue</a>. The key change is as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">diff --git a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java\nindex 2daadddee6..53834fb81d 100644\n<span class=\"token coord\">--- a/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java</span>\n<span class=\"token coord\">+++ b/clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java</span>\n@@ -198,46 +214,44 @@ public abstract class AbstractCoordinator implements Closeable {\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>                                           ByteBuffer memberAssignment);\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>    /**\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>     * Block until the coordinator for this group is known and is ready to receive requests.\n<span class=\"token prefix deleted\">-</span>     */\n<span class=\"token prefix deleted\">-</span>    public synchronized void ensureCoordinatorReady() {\n<span class=\"token prefix deleted\">-</span>        // Using zero as current time since timeout is effectively infinite\n<span class=\"token prefix deleted\">-</span>        ensureCoordinatorReady(0, Long.MAX_VALUE);\n<span class=\"token prefix deleted\">-</span>    }\n<span class=\"token prefix deleted\">-</span>\n<span class=\"token prefix deleted\">-</span>    /**\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>     * Visible for testing.\n<span class=\"token prefix inserted\">+</span>     *\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>     * Ensure that the coordinator is ready to receive requests.\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>     * @param startTimeMs Current time in milliseconds\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>     *\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>     * @param timeoutMs Maximum time to wait to discover the coordinator\n<span class=\"token prefix unchanged\"> </span>     * @return true If coordinator discovery and initial connection succeeded, false otherwise\n<span class=\"token prefix unchanged\"> </span>     */\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>    protected synchronized boolean ensureCoordinatorReady(long startTimeMs, long timeoutMs) {\n<span class=\"token prefix deleted\">-</span>        long remainingMs = timeoutMs;\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>    protected synchronized boolean ensureCoordinatorReady(final long timeoutMs) {\n<span class=\"token prefix inserted\">+</span>        final long startTimeMs = time.milliseconds();\n<span class=\"token prefix inserted\">+</span>        long elapsedTime = 0L;\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>        while (coordinatorUnknown()) {\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>            RequestFuture&lt;Void> future = lookupCoordinator();\n<span class=\"token prefix deleted\">-</span>            client.poll(future, remainingMs);\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>            final RequestFuture&lt;Void> future = lookupCoordinator();\n<span class=\"token prefix inserted\">+</span>            client.poll(future, remainingTimeAtLeastZero(timeoutMs, elapsedTime));\n<span class=\"token prefix inserted\">+</span>            if (!future.isDone()) {\n<span class=\"token prefix inserted\">+</span>                // ran out of time\n<span class=\"token prefix inserted\">+</span>                break;\n<span class=\"token prefix inserted\">+</span>            }\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>            if (future.failed()) {\n<span class=\"token prefix unchanged\"> </span>                if (future.isRetriable()) {\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>                    remainingMs = timeoutMs - (time.milliseconds() - startTimeMs);\n<span class=\"token prefix deleted\">-</span>                    if (remainingMs &lt;= 0)\n<span class=\"token prefix deleted\">-</span>                        break;\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>                    elapsedTime = time.milliseconds() - startTimeMs;\n<span class=\"token prefix inserted\">+</span>\n<span class=\"token prefix inserted\">+</span>                    if (elapsedTime >= timeoutMs) break;\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>                    log.debug(\"Coordinator discovery failed, refreshing metadata\");\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>                    client.awaitMetadataUpdate(remainingMs);\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>                    client.awaitMetadataUpdate(remainingTimeAtLeastZero(timeoutMs, elapsedTime));\n<span class=\"token prefix inserted\">+</span>                    elapsedTime = time.milliseconds() - startTimeMs;\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>                } else\n<span class=\"token prefix unchanged\"> </span>                    throw future.exception();\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>            } else if (coordinator != null &amp;&amp; client.connectionFailed(coordinator)) {\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>            } else if (coordinator != null &amp;&amp; client.isUnavailable(coordinator)) {\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>                // we found the coordinator, but the connection has failed, so mark\n<span class=\"token prefix unchanged\"> </span>                // it dead and backoff before retrying discovery\n<span class=\"token prefix unchanged\"> </span>                markCoordinatorUnknown();\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>                time.sleep(retryBackoffMs);\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>                final long sleepTime = Math.min(retryBackoffMs, remainingTimeAtLeastZero(timeoutMs, elapsedTime));\n<span class=\"token prefix inserted\">+</span>                time.sleep(sleepTime);\n<span class=\"token prefix inserted\">+</span>                elapsedTime += sleepTime;\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>            }\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>\n<span class=\"token prefix deleted\">-</span>            remainingMs = timeoutMs - (time.milliseconds() - startTimeMs);\n<span class=\"token prefix deleted\">-</span>            if (remainingMs &lt;= 0)\n<span class=\"token prefix deleted\">-</span>                break;\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>        }\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>        return !coordinatorUnknown();</span></code></pre></div>\n<h2 id=\"our-blocker\" style=\"position:relative;\"><a href=\"#our-blocker\" aria-label=\"our blocker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Our Blocker</h2>\n<p>We could not bring in the official solution because of the following reasons:</p>\n<ul>\n<li>our application uses Java 7, and could not be migrated to Java 8 since we could not change the JVM version</li>\n<li>the official solution is patched to Kafka 2.0, which requires Java 8 or higher</li>\n<li>Kafka 1.1.1 does not have the official solution patched</li>\n</ul>\n<h2 id=\"hack-solution\" style=\"position:relative;\"><a href=\"#hack-solution\" aria-label=\"hack solution permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hack Solution</h2>\n<p>We have to come up with a hack solution to work around the blocker. The hack solution is as follows:</p>\n<ul>\n<li>\n<p>The major call is wrapped with a java future to ensure the timeout, usually a poll should be finised in <em>100 ms</em>, if not, when the <em>60_000 ms (1 min)</em> limit exceeded, the poll will exit.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">KafkaTimeoutEnsuredPollWorker</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> worker <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">KafkaTimeoutEnsuredPollWorker</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>kafkaConsumer<span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ConsumerRecords</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> future <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>executor<span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span>worker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> future<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">60_000</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MILLISECONDS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">exitPoll</span><span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">String</span> message <span class=\"token operator\">=</span> <span class=\"token string\">\"interrupted when poll kafka data, timeout = 100 ms\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KafkaException</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">TimeoutException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">exitPoll</span><span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">String</span> message <span class=\"token operator\">=</span> <span class=\"token string\">\"timeout when poll kafka data, timeout = 100 ms\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KafkaException</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ExecutionException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">exitPoll</span><span class=\"token punctuation\">(</span>future<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getCause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">KafkaException</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">KafkaException</span><span class=\"token punctuation\">)</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getCause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KafkaException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getCause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>The <code class=\"language-text\">exitPoll</code> method is used to ensure the future is done.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">exitPoll</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ConsumerRecords</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> future<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>future<span class=\"token punctuation\">.</span><span class=\"token function\">isDone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    future<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MILLISECONDS</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ignore</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>The class <code class=\"language-text\">KafkaTimeoutEnsuredPollWorker</code> implements the <code class=\"language-text\">Callable</code> interface.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KafkaTimeoutEnsuredPollWorker</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Callable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ConsumerRecords</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">KafkaConsumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> kafkaConsumer<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> timeoutMillisecond<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">KafkaTimeoutEnsuredPollWorker</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KafkaConsumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> kafkaConsumer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> timeoutMillisecond<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>kafkaConsumer <span class=\"token operator\">=</span> kafkaConsumer<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>timeoutMillisecond <span class=\"token operator\">=</span> timeoutMillisecond<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">ConsumerRecords</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">K</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">V</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>kafkaConsumer<span class=\"token punctuation\">.</span><span class=\"token function\">poll</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>timeoutMillisecond<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>","fields":{"slug":"/posts/2020-09-02---Dancing-in-Shackles-Caused-by-an-Unupgradable-Kafka//posts/dancing-in-shackles-caused-by-an-unupgradable-kafka","tagSlugs":["/tag/programming/","/tag/kafka/"]},"frontmatter":{"date":"2020-09-02T21:05:00.000Z","description":"a story about how to get a hack solution to work around a kafka bug when its upgrade is blocked by the java version and the official solution is not available.","tags":["Programming","Kafka"],"title":"Dancing in Shackles Caused by an Unupgradable Kafka","socialImage":{"publicURL":"/static/7e91be4d6ad8c98e2cbc65cf6ef97884/shackles-kafka-java.jpg"}}}},"pageContext":{"slug":"/posts/2020-09-02---Dancing-in-Shackles-Caused-by-an-Unupgradable-Kafka//posts/dancing-in-shackles-caused-by-an-unupgradable-kafka"}},"staticQueryHashes":["251939775","288581551","401334301"],"slicesMap":{}}