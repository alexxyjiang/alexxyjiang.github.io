{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/building-docker-image-with-multi-arch-support/","result":{"data":{"markdownRemark":{"id":"c91b31ed-8fdc-5acc-a46f-67b4f67d5c00","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f1fe386a90b93cdf44c3e690066dff8d/4b190/cross-arch-docker-image.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHrXZIpf//EABkQAAIDAQAAAAAAAAAAAAAAAAEhAhARMf/aAAgBAQABBQLWS48v/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFREBAQAAAAAAAAAAAAAAAAAAEEH/2gAIAQIBAT8Bp//EABcQAAMBAAAAAAAAAAAAAAAAAAABICH/2gAIAQEABj8CYjY//8QAGhABAAIDAQAAAAAAAAAAAAAAAQAREEFRYf/aAAgBAQABPyFdfPIwXYlO0ouJj//aAAwDAQACAAMAAAAQBM//xAAWEQADAAAAAAAAAAAAAAAAAAAQEUH/2gAIAQMBAT8QiH//xAAXEQEAAwAAAAAAAAAAAAAAAAAAIUFR/9oACAECAQE/ENJt/8QAGhABAQEBAQEBAAAAAAAAAAAAAREAIUFRsf/aAAgBAQABPxAtBCTr39xDSVePzMSH1CZ6IXAygzBDm//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f1fe386a90b93cdf44c3e690066dff8d/8ac56/cross-arch-docker-image.webp 240w,\n/static/f1fe386a90b93cdf44c3e690066dff8d/d3be9/cross-arch-docker-image.webp 480w,\n/static/f1fe386a90b93cdf44c3e690066dff8d/d00b9/cross-arch-docker-image.webp 800w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f1fe386a90b93cdf44c3e690066dff8d/09b79/cross-arch-docker-image.jpg 240w,\n/static/f1fe386a90b93cdf44c3e690066dff8d/7cc5e/cross-arch-docker-image.jpg 480w,\n/static/f1fe386a90b93cdf44c3e690066dff8d/4b190/cross-arch-docker-image.jpg 800w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f1fe386a90b93cdf44c3e690066dff8d/4b190/cross-arch-docker-image.jpg\"\n            alt=\"cross-arch-docker-image\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Cross-platform deployment is a common requirement for modern software development. The multi-arch docker image is a good practice for cross-platform deployment. Especially, if the docker image has to be deployed in the different CPU architectures, the multi-arch docker image will provide the best performance and compatibility. For example, if the docker engine is running on the arm64 CPU, the arm64 docker image will be pulled and executed, if no arm64 docker image is available, another arch docker image like amd64 will be pulled. This is a run-time emulation, and the performance will be abysmal.</p>\n<h2 id=\"how-to-build-a-multi-arch-docker-image\" style=\"position:relative;\"><a href=\"#how-to-build-a-multi-arch-docker-image\" aria-label=\"how to build a multi arch docker image permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to build a multi-arch docker image</h2>\n<p>To build a multi-arch docker image, the <a href=\"https://docs.docker.com/build/building/multi-platform\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">official guide</a> is available.</p>\n<ul>\n<li>\n<p>We can use different strategies, one is real-time emulation with <code class=\"language-text\">qemu</code>, to achieve this, just execute the command below:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--privileged</span> <span class=\"token parameter variable\">--rm</span> tonistiigi/binfmt <span class=\"token parameter variable\">--install</span> all</code></pre></div>\n<p>Then we can build the multi-arch docker image like below:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">docker</span> build <span class=\"token parameter variable\">--platform</span> linux/amd64,linux/arm64 <span class=\"token builtin class-name\">.</span></code></pre></div>\n</li>\n<li>\n<p>Another strategy is to use the <code class=\"language-text\">buildx</code> command, which is a new feature of the docker engine. The <code class=\"language-text\">buildx</code> command is a CLI plugin that extends the docker command with the full support of the features provided by Moby BuildKit builder toolkit. To use the <code class=\"language-text\">buildx</code> command, we need to install the <code class=\"language-text\">buildx</code> plugin first. For MacOS, the <code class=\"language-text\">buildx</code> plugin is already included in the docker desktop, for Debian, we need to install the <code class=\"language-text\">buildx</code> plugin manually like below:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># debian</span>\n<span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token comment\"># apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span></code></pre></div>\n<p>Then we can use the <code class=\"language-text\">buildx</code> command to build the multi-arch docker images.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">docker</span> buildx build <span class=\"token parameter variable\">--platform</span> linux/amd64,linux/arm64 <span class=\"token builtin class-name\">.</span></code></pre></div>\n</li>\n</ul>\n<h2 id=\"optimize-the-build-process\" style=\"position:relative;\"><a href=\"#optimize-the-build-process\" aria-label=\"optimize the build process permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Optimize the build process</h2>\n<p>Generally, previous guide are based on full emulation in building. When the multi-arch packages are pre-compiled, and we just install them in the building process, the performance is still acceptable. But if the compilation is required, the performance will be abysmal, because the full-emulation compilation is too slow.</p>\n<p>To optimize this, please follow the <a href=\"https://www.docker.com/blog/faster-multi-platform-builds-dockerfile-cross-compilation-guide\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">guide</a>. Generally, weâ€™re using a cross-compilation toolchain to build the multi-arch packages, and then install them in the building process. The performance will be improved significantly.</p>\n<p>For example, to build an <strong>arm64</strong> docker image,</p>\n<ul>\n<li>the <strong>native</strong> way is to build with arm64 hardware</li>\n<li>the <strong>emulator</strong> way is to build the arm64 packages on the amd64 machine with full-emulation</li>\n<li>the <strong>cross</strong> way is to build the arm64 packages on the amd64 machine with the arm64 toolchain</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th align=\"left\"></th>\n<th align=\"left\">native</th>\n<th align=\"left\">emulator</th>\n<th align=\"left\">cross</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\">machine</td>\n<td align=\"left\">arm64</td>\n<td align=\"left\">amd64</td>\n<td align=\"left\">amd64</td>\n</tr>\n<tr>\n<td align=\"left\">compiler</td>\n<td align=\"left\">arm64</td>\n<td align=\"left\">arm64</td>\n<td align=\"left\">amd64</td>\n</tr>\n<tr>\n<td align=\"left\">target</td>\n<td align=\"left\">arm64</td>\n<td align=\"left\">arm64</td>\n<td align=\"left\">arm64</td>\n</tr>\n</tbody>\n</table>\n<p>The <strong>cross</strong> way is the best choice for the multi-arch docker image building when the hardware and the <strong>native</strong> way are not available.</p>","fields":{"slug":"/posts/2024-08-28---Building-Docker-Image-with-Multi-arch-Support//posts/building-docker-image-with-multi-arch-support","tagSlugs":["/tag/virtualization/","/tag/docker/"]},"frontmatter":{"date":"2024-08-28T21:00:00.000Z","description":"the multi-arch docker image is a good practice for the cross-platform deployment.","tags":["Virtualization","Docker"],"title":"Building Docker Image with Multi-arch Support","socialImage":{"publicURL":"/static/f1fe386a90b93cdf44c3e690066dff8d/cross-arch-docker-image.jpg"}}}},"pageContext":{"slug":"/posts/2024-08-28---Building-Docker-Image-with-Multi-arch-Support//posts/building-docker-image-with-multi-arch-support"}},"staticQueryHashes":["251939775","288581551","401334301"],"slicesMap":{}}