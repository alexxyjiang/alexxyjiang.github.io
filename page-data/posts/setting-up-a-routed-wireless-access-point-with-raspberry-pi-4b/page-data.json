{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/setting-up-a-routed-wireless-access-point-with-raspberry-pi-4b","result":{"data":{"markdownRemark":{"id":"f29d7c88-ff2d-507f-9ded-72a17d5f4958","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/39536d8b9350a0cfa3b095c37e816f76/4b190/rpi-wifi.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAUBAgME/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAa5dUQpGgf/EABoQAAICAwAAAAAAAAAAAAAAAAECABEDEBL/2gAIAQEAAQUCJqNRj4W63//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABoQAAEFAQAAAAAAAAAAAAAAAAABESAiMWH/2gAIAQEABj8CxRulch//xAAaEAEBAAIDAAAAAAAAAAAAAAABEQAgITFx/9oACAEBAAE/IQUp4Yont5GCUXR//9oADAMBAAIAAwAAABDsH//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/EFf/xAAbEAEAAwEAAwAAAAAAAAAAAAABABEhMVFhkf/aAAgBAQABPxDYFXbyLosAgiBrfybNum89SjwRC1o7Hs//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/39536d8b9350a0cfa3b095c37e816f76/8ac56/rpi-wifi.webp 240w,\n/static/39536d8b9350a0cfa3b095c37e816f76/d3be9/rpi-wifi.webp 480w,\n/static/39536d8b9350a0cfa3b095c37e816f76/d00b9/rpi-wifi.webp 800w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/39536d8b9350a0cfa3b095c37e816f76/09b79/rpi-wifi.jpg 240w,\n/static/39536d8b9350a0cfa3b095c37e816f76/7cc5e/rpi-wifi.jpg 480w,\n/static/39536d8b9350a0cfa3b095c37e816f76/4b190/rpi-wifi.jpg 800w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/39536d8b9350a0cfa3b095c37e816f76/4b190/rpi-wifi.jpg\"\n            alt=\"rpi-wifi\"\n            title=\"rpi-wifi\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>To set up a routed wireless access point with Raspberry Pi 4B is very interesting. The Raspberry Pi is shipped together with some integrated wireless actually, manufactured by <strong>Raspberry Pi Trading Ltd</strong>. The performance of the integrated wireless is fair but not good enough. It supports 802.11a/b/g/n/ac, but itâ€™s a little unstable.</p>\n<p>To enable a more stable 802.11ac/ax wireless network, I believe some extended antenna wireless card is required. My choice is the <a href=\"https://www.szedup.com/product-item/edup-802-11ac-ep-ac1686-receiver-wifi-usb-wifi-adapter-1300mbps-wireless-dongle/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">EDUP 802.11ac EP-AC1686</a>, which is the cheapest RTL8812BU chipset. Because I would take the 1Gps wired port as the upstream of the Raspberry Pi network, the 1300Mbps 802.11ac wireless network is good enough.</p>\n<h2 id=\"hardware\" style=\"position:relative;\"><a href=\"#hardware\" aria-label=\"hardware permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hardware</h2>\n<ul>\n<li><a href=\"https://www.raspberrypi.org/products/raspberry-pi-4-model-b/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Raspberry Pi 4B ver 1.1</a></li>\n<li><a href=\"https://www.szedup.com/product-item/edup-802-11ac-ep-ac1686-receiver-wifi-usb-wifi-adapter-1300mbps-wireless-dongle/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">EDUP 802.11ac EP-AC1686</a></li>\n</ul>\n<h2 id=\"software\" style=\"position:relative;\"><a href=\"#software\" aria-label=\"software permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Software</h2>\n<ol>\n<li>\n<p><strong>install the wireless card driver</strong></p>\n<ul>\n<li><em>plug-in the usb 3.0 device</em>, prepare source code, the driver source code for realtek network chips could be downloaded from <a href=\"https://github.com/alexxyjiang/rtl88x2bu/tree/5.8.7.1\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>.</li>\n<li>compile and install the driver, follow the instructions in source code <a href=\"https://github.com/alexxyjiang/rtl88x2bu/blob/5.8.7.1/README.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">README</a>. You should verify the driver is successfully installed via following command, and fetch the device name start with <strong>wlx</strong>.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ iwconfig</code></pre></div>\n<p>If your wifi device is not found, you may need to unblock that,</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token comment\"># rfkill unblock wlan</span></code></pre></div>\n<ul>\n<li>turn on cpu overlock, disable the bluetooth and integrated wireless, add following lines to the <strong>/boot/config.txt</strong> in Raspberry Pi 4. The file-system path <strong>/boot</strong> may be mounted in read-only mode, you could re-mount that.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># overlocking\narm_freq=1500\nover_voltage=2\n# disable integrated wifi and bluetooth\ndtoverlay=disable-wifi\ndtoverlay=disable-bt</code></pre></div>\n</li>\n<li>\n<p><strong>configure the network</strong></p>\n<ul>\n<li><strong>dhcpcd</strong> static address for wireless card, append following lines to file <strong>/etc/dhcpcd.conf</strong>, replace key information with yourself settings.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">interface %wlx_device_name%\nstatic ip_address=%ap_ipv4_address%/24\nnohook wpa_supplicant</code></pre></div>\n<ul>\n<li><strong>dnsmasq</strong> dhcp service and dns service, install the dnsmasq first,</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token comment\"># apt install dnsmasq</span></code></pre></div>\n<p>then replace the <strong>/etc/dnsmasq.conf</strong> file with following lines.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># dns cache size\ncache-size=4096\n# never forward plain names (without a dot or domain part)\ndomain-needed\n# local domain name\ndomain=wlan\n# local address\ninterface=%wlx_device_name%\naddress=/rpi.wlan/%ap_ipv4_address%\n# don't poll for changes in /etc/resolv.conf\nno-poll\n# don't use /etc/resolv.conf or any other file\nno-resolv\n# dhcp related configuration\ndhcp-mac=set:client_is_a_pi,B8:27:EB:*:*:*\ndhcp-reply-delay=tag:client_is_a_pi,2\ndhcp-range=%ipv4_address_start%,%ipv4_address_end%,%netmask%,6h</code></pre></div>\n<ul>\n<li><strong>hostapd</strong> ap service binary, install the hostapd first,</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token comment\"># apt install hostapd</span>\n<span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token comment\"># systemctl unmask hostapd</span>\n<span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token comment\"># systemctl enable hostapd</span></code></pre></div>\n<p>edit the <strong>/etc/hostapd/hostapd.conf</strong> file.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">country_code=%2_char_country_code%\ninterface=%wlx_device_name%\ndriver=nl80211\n# hidden network\nssid=%wifi_ssid%\nignore_broadcast_ssid=1\n# 802.11a/n/ac\nhw_mode=a\n# channel=0 # auto detect channel\nchannel=40 # 80hz channel 36-48, center = 42\nieee80211d=1\nieee80211n=1\nieee80211ac=1\n# features should be aligned with your wifi device, the following is for RTL8812BU\nht_capab=[LDPC][HT40-][MAX-AMSDU-7935][SHORT-GI-20][SHORT-GI-40]\nvht_capab=[RXLDPC][HTC-VHT][MAX-MPDU-11454][SHORT-GI-80]\nvht_oper_chwidth=1\nvht_oper_centr_freq_seg0_idx=42\n# wmm quality control for 802.11n/ac\nwmm_enabled=1\n# wpa2 auth\nmacaddr_acl=0\nauth_algs=1\nwpa=2\nwpa_passphrase=%network_passphrase%\nwpa_key_mgmt=WPA-PSK\nwpa_pairwise=CCMP\nrsn_pairwise=CCMP</code></pre></div>\n<ul>\n<li><strong>iptables</strong> network forwarding, install iptables,</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token comment\"># apt install netfilter-persistent iptables-persistent</span></code></pre></div>\n<p>add ipv4 forwarding, edit file <strong>/etc/sysctl.d/ipv4-forward.conf</strong>,</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">net.ipv4.ip_forward=1</code></pre></div>\n<p>add masquerade iptables rule and save it as persistent rules,</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token comment\"># iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>\n<span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token comment\"># netfilter-persistent save</span></code></pre></div>\n</li>\n<li>\n<p>reboot your Raspberry Pi 4 and enable your ap</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token comment\"># reboot</span></code></pre></div>\n</li>\n</ol>\n<h2 id=\"references\" style=\"position:relative;\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h2>\n<ul>\n<li><a href=\"https://www.raspberrypi.org/documentation/computers/configuration.html#setting-up-a-routed-wireless-access-point\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.raspberrypi.org/documentation/computers/configuration.html#setting-up-a-routed-wireless-access-point</a></li>\n<li><a href=\"https://github.com/alexxyjiang/rtl88x2bu/blob/5.8.7.1/README.md\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/alexxyjiang/rtl88x2bu/blob/5.8.7.1/README.md</a></li>\n</ul>","fields":{"slug":"/posts/2021-08-21---Setting-up-a-Routed-Wireless-Access-Point-with-Raspberry-Pi-4B//posts/setting-up-a-routed-wireless-access-point-with-raspberry-pi-4b","tagSlugs":["/tag/linux-system/","/tag/raspberry-pi/"]},"frontmatter":{"date":"2021-08-21T14:50:00.000+0800","description":"instructions about how to install software and set up a routed wireless AP with Pi 4B.","tags":["Linux System","Raspberry Pi"],"title":"Setting up a Routed Wireless Access Point with Raspberry Pi 4B","socialImage":{"publicURL":"/static/39536d8b9350a0cfa3b095c37e816f76/rpi-wifi.jpg"}}}},"pageContext":{"slug":"/posts/2021-08-21---Setting-up-a-Routed-Wireless-Access-Point-with-Raspberry-Pi-4B//posts/setting-up-a-routed-wireless-access-point-with-raspberry-pi-4b"}},"staticQueryHashes":["251939775","2764776372","401334301"]}