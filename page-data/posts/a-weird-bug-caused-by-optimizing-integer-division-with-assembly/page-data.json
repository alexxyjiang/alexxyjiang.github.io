{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/a-weird-bug-caused-by-optimizing-integer-division-with-assembly/","result":{"data":{"markdownRemark":{"id":"a2e55a2e-87d4-5275-9398-5eb88af54138","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9e7467366f8cd66a9571f31a5421eb36/4b190/weird-assembly.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHCmRWK/8QAFxAAAwEAAAAAAAAAAAAAAAAAAQIQMf/aAAgBAQABBQIa0//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABYQAAMAAAAAAAAAAAAAAAAAAAABEP/aAAgBAQAGPwIU/8QAFxAAAwEAAAAAAAAAAAAAAAAAABAxgf/aAAgBAQABPyEIjF//2gAMAwEAAgADAAAAEIgP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFREBAQAAAAAAAAAAAAAAAAAAEEH/2gAIAQIBAT8Qp//EABwQAAIABwAAAAAAAAAAAAAAAAERABAhMUFxsf/aAAgBAQABPxBUdq8gwoY7S//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/9e7467366f8cd66a9571f31a5421eb36/8ac56/weird-assembly.webp 240w,\n/static/9e7467366f8cd66a9571f31a5421eb36/d3be9/weird-assembly.webp 480w,\n/static/9e7467366f8cd66a9571f31a5421eb36/d00b9/weird-assembly.webp 800w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/9e7467366f8cd66a9571f31a5421eb36/09b79/weird-assembly.jpg 240w,\n/static/9e7467366f8cd66a9571f31a5421eb36/7cc5e/weird-assembly.jpg 480w,\n/static/9e7467366f8cd66a9571f31a5421eb36/4b190/weird-assembly.jpg 800w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/9e7467366f8cd66a9571f31a5421eb36/4b190/weird-assembly.jpg\"\n            alt=\"assembly\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Recently, I encountered a weird bug in my code. I was trying to optimize a piece of code with assembly. The code was written in C, and I wanted to optimize the division operation. I thought that using assembly would be a good idea, but it turned out to be a disaster. It took me more than 3 hours to figure out what was going on. I didnâ€™t get significant performance improvement even after I fixed the bug and optimized the code.</p>\n<p>The code was simple. As we know, the x86 architecture provides a division instruction that outputs the quotient and the remainder together. But in the C code, we have to write the division statement twice to get the quotient and the remainder. I thought the assembly code could be used to optimize the division operation. The code before optimization was like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// prog_purec.c</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n\n<span class=\"token comment\">// Define the problem scale</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXN</span> <span class=\"token expression\"><span class=\"token number\">5000004</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXP</span> <span class=\"token expression\"><span class=\"token number\">350000</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXR</span> <span class=\"token expression\"><span class=\"token number\">2236</span></span></span>\n\n<span class=\"token keyword\">char</span> mk<span class=\"token punctuation\">[</span>MAXN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// Prime bits</span>\n<span class=\"token keyword\">int</span> prime<span class=\"token punctuation\">[</span>MAXP<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> pnum<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Primes</span>\n<span class=\"token keyword\">int</span> c<span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>             <span class=\"token comment\">// Array for generating answer</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">32</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        c<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Sum of i^3</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> MAXN<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mk<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            prime<span class=\"token punctuation\">[</span>pnum<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> MAXR<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> i<span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> MAXN<span class=\"token punctuation\">;</span> j <span class=\"token operator\">+=</span> i<span class=\"token punctuation\">)</span>\n                    mk<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">,</span> ncase<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ncase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ncase<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        res <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> pnum<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mk<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n                    res <span class=\"token operator\">*=</span> c<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">else</span>\n            <span class=\"token punctuation\">{</span>\n                j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">%</span> prime<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">{</span>\n                    n <span class=\"token operator\">/=</span> prime<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                    j<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n                    res <span class=\"token operator\">*=</span> c<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\\n\"</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">.file    <span class=\"token string\">\"prog_purec.c\"</span>\n.text\n.globl init\n.type    init, @function\n<span class=\"token label function\">init:</span>\n    pushl    <span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>\n    subl    <span class=\"token number\">$16</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>\n    movl    <span class=\"token number\">$0</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L2\n<span class=\"token label function\">.L3:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    addl    <span class=\"token number\">$2</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    addl    <span class=\"token number\">$2</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    imull    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    incl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    imull    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    incl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    imull    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    sarl    <span class=\"token number\">$2</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, c(,<span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>,<span class=\"token number\">4</span>)\n    incl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L2:</span>\n    cmpl    <span class=\"token number\">$31</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jle    .L3\n    movl    <span class=\"token number\">$2</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L5\n<span class=\"token label function\">.L6:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movzbl    mk(<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    testb    <span class=\"token operator\">%</span><span class=\"token register variable\">al</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">al</span>\n    jne    .L7\n    movl    pnum, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, prime(,<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>,<span class=\"token number\">4</span>)\n    incl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, pnum\n    cmpl    <span class=\"token number\">$2235</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jg    .L7\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    imull    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L10\n<span class=\"token label function\">.L11:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movb    <span class=\"token number\">$1</span>, mk(<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>)\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    addl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L10:</span>\n    cmpl    <span class=\"token number\">$5000003</span>, <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jle    .L11\n<span class=\"token label function\">.L7:</span>\n    incl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L5:</span>\n    cmpl    <span class=\"token number\">$5000003</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jle    .L6\n    leave\n    ret\n    .size    init, .<span class=\"token operator\">-</span>init\n    .section    .rodata\n<span class=\"token label function\">.LC0:</span>\n    .string    <span class=\"token string\">\"%d\"</span>\n<span class=\"token label function\">.LC1:</span>\n    .string    <span class=\"token string\">\"%d\\n\"</span>\n    .text\n.globl main\n    .type    main, @function\n<span class=\"token label function\">main:</span>\n    leal    <span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>\n    andl    <span class=\"token operator\">$</span><span class=\"token operator\">-</span><span class=\"token number\">16</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>\n    pushl    <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>)\n    pushl    <span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>\n    pushl    <span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>\n    subl    <span class=\"token number\">$52</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>\n    call    init\n    leal    <span class=\"token operator\">-</span><span class=\"token number\">20</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    movl    <span class=\"token operator\">$</span>.LC0, (<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    call    scanf\n    jmp    .L15\n<span class=\"token label function\">.L16:</span>\n    leal    <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    movl    <span class=\"token operator\">$</span>.LC0, (<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    call    scanf\n    movl    <span class=\"token number\">$1</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token number\">$0</span>, <span class=\"token operator\">-</span><span class=\"token number\">16</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L17\n<span class=\"token label function\">.L18:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movzbl    mk(<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    testb    <span class=\"token operator\">%</span><span class=\"token register variable\">al</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">al</span>\n    jne    .L19\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    cmpl    <span class=\"token number\">$1</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    jle    .L23\n    movl    c<span class=\"token operator\">+</span><span class=\"token number\">4</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    imull    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L23\n<span class=\"token label function\">.L19:</span>\n    movl    <span class=\"token number\">$0</span>, <span class=\"token operator\">-</span><span class=\"token number\">12</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L24\n<span class=\"token label function\">.L25:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">16</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    prime(,<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>,<span class=\"token number\">4</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">40</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    cltd\n    idivl    <span class=\"token operator\">-</span><span class=\"token number\">40</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">40</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">40</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    incl    <span class=\"token operator\">-</span><span class=\"token number\">12</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L24:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">16</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    prime(,<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>,<span class=\"token number\">4</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">40</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    cltd\n    idivl    <span class=\"token operator\">-</span><span class=\"token number\">40</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    testl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    je    .L25\n    cmpl    <span class=\"token number\">$0</span>, <span class=\"token operator\">-</span><span class=\"token number\">12</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jle    .L27\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">12</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    c(,<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>,<span class=\"token number\">4</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    imull    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L27:</span>\n    incl    <span class=\"token operator\">-</span><span class=\"token number\">16</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L17:</span>\n    movl    pnum, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    cmpl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">16</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jl    .L18\n<span class=\"token label function\">.L23:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    movl    <span class=\"token operator\">$</span>.LC1, (<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    call    printf\n<span class=\"token label function\">.L15:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">20</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    decl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">20</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">20</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    cmpl    <span class=\"token operator\">$</span><span class=\"token operator\">-</span><span class=\"token number\">1</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    jne    .L16\n    movl    <span class=\"token number\">$0</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    addl    <span class=\"token number\">$52</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>\n    popl    <span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>\n    popl    <span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>\n    leal    <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>\n    ret\n    .size    main, .<span class=\"token operator\">-</span>main\n    .comm    mk,<span class=\"token number\">5000004</span>,<span class=\"token number\">32</span>\n    .comm    prime,<span class=\"token number\">1400000</span>,<span class=\"token number\">32</span>\n    .comm    pnum,<span class=\"token number\">4</span>,<span class=\"token number\">4</span>\n    .comm    c,<span class=\"token number\">128</span>,<span class=\"token number\">32</span>\n    .ident    <span class=\"token string\">\"GCC: (GNU) 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)\"</span>\n    .section    .note.GNU<span class=\"token operator\">-</span>stack,<span class=\"token string\">\"\"</span>,@progbits</code></pre></div>\n<p>The code of my first trial of optimization was like:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// prog_asm.c</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n\n<span class=\"token comment\">// Define the problem scale</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXN</span> <span class=\"token expression\"><span class=\"token number\">5000004</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXP</span> <span class=\"token expression\"><span class=\"token number\">350000</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXR</span> <span class=\"token expression\"><span class=\"token number\">2236</span></span></span>\n\n<span class=\"token keyword\">char</span> mk<span class=\"token punctuation\">[</span>MAXN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// Prime bits</span>\n<span class=\"token keyword\">int</span> prime<span class=\"token punctuation\">[</span>MAXP<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> pnum<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Primes</span>\n<span class=\"token keyword\">int</span> c<span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>             <span class=\"token comment\">// Array for generating answer</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">32</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        c<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> MAXN<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mk<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            prime<span class=\"token punctuation\">[</span>pnum<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> MAXR<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> i<span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> MAXN<span class=\"token punctuation\">;</span> j <span class=\"token operator\">+=</span> i<span class=\"token punctuation\">)</span>\n                    mk<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">,</span> ncase<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ncase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ncase<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        res <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> pnum<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mk<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n                    res <span class=\"token operator\">*=</span> c<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">else</span>\n            <span class=\"token punctuation\">{</span>\n                j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">%</span> prime<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"movl    %eax, -24(%ebp)\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    j<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n                    res <span class=\"token operator\">*=</span> c<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\\n\"</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"nasm\"><pre class=\"language-nasm\"><code class=\"language-nasm\">.file    <span class=\"token string\">\"prog_asm.c\"</span>\n.text\n.globl init\n.type    init, @function\n<span class=\"token label function\">init:</span>\n    pushl    <span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>\n    subl    <span class=\"token number\">$16</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>\n    movl    <span class=\"token number\">$0</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L2\n<span class=\"token label function\">.L3:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    addl    <span class=\"token number\">$2</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    addl    <span class=\"token number\">$2</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    imull    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    incl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    imull    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    incl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    imull    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    sarl    <span class=\"token number\">$2</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, c(,<span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>,<span class=\"token number\">4</span>)\n    incl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L2:</span>\n    cmpl    <span class=\"token number\">$31</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jle    .L3\n    movl    <span class=\"token number\">$2</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L5\n<span class=\"token label function\">.L6:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movzbl    mk(<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    testb    <span class=\"token operator\">%</span><span class=\"token register variable\">al</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">al</span>\n    jne    .L7\n    movl    pnum, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, prime(,<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>,<span class=\"token number\">4</span>)\n    incl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, pnum\n    cmpl    <span class=\"token number\">$2235</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jg    .L7\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    imull    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L10\n<span class=\"token label function\">.L11:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movb    <span class=\"token number\">$1</span>, mk(<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>)\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    addl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L10:</span>\n    cmpl    <span class=\"token number\">$5000003</span>, <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jle    .L11\n<span class=\"token label function\">.L7:</span>\n    incl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L5:</span>\n    cmpl    <span class=\"token number\">$5000003</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jle    .L6\n    leave\n    ret\n    .size    init, .<span class=\"token operator\">-</span>init\n    .section    .rodata\n<span class=\"token label function\">.LC0:</span>\n    .string    <span class=\"token string\">\"%d\"</span>\n<span class=\"token label function\">.LC1:</span>\n    .string    <span class=\"token string\">\"%d\\n\"</span>\n    .text\n.globl main\n    .type    main, @function\n<span class=\"token label function\">main:</span>\n    leal    <span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>\n    andl    <span class=\"token operator\">$</span><span class=\"token operator\">-</span><span class=\"token number\">16</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>\n    pushl    <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>)\n    pushl    <span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>\n    pushl    <span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>\n    subl    <span class=\"token number\">$52</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>\n    call    init\n    leal    <span class=\"token operator\">-</span><span class=\"token number\">20</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    movl    <span class=\"token operator\">$</span>.LC0, (<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    call    scanf\n    jmp    .L15\n<span class=\"token label function\">.L16:</span>\n    leal    <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    movl    <span class=\"token operator\">$</span>.LC0, (<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    call    scanf\n    movl    <span class=\"token number\">$1</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token number\">$0</span>, <span class=\"token operator\">-</span><span class=\"token number\">16</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L17\n<span class=\"token label function\">.L18:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movzbl    mk(<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    testb    <span class=\"token operator\">%</span><span class=\"token register variable\">al</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">al</span>\n    jne    .L19\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    cmpl    <span class=\"token number\">$1</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    jle    .L23\n    movl    c<span class=\"token operator\">+</span><span class=\"token number\">4</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    imull    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L23\n<span class=\"token label function\">.L19:</span>\n    movl    <span class=\"token number\">$0</span>, <span class=\"token operator\">-</span><span class=\"token number\">12</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jmp    .L24\n<span class=\"token label function\">.L25:</span>\n#APP\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n#NO_APP\n    incl    <span class=\"token operator\">-</span><span class=\"token number\">12</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L24:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">24</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">16</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    prime(,<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>,<span class=\"token number\">4</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">40</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    cltd\n    idivl    <span class=\"token operator\">-</span><span class=\"token number\">40</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    testl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    je    .L25\n    cmpl    <span class=\"token number\">$0</span>, <span class=\"token operator\">-</span><span class=\"token number\">12</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jle    .L27\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">12</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    c(,<span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>,<span class=\"token number\">4</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    imull    <span class=\"token operator\">%</span><span class=\"token register variable\">edx</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L27:</span>\n    incl    <span class=\"token operator\">-</span><span class=\"token number\">16</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n<span class=\"token label function\">.L17:</span>\n    movl    pnum, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    cmpl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">16</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    jl    .L18\n<span class=\"token label function\">.L23:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">8</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    movl    <span class=\"token operator\">$</span>.LC1, (<span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>)\n    call    printf\n<span class=\"token label function\">.L15:</span>\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">20</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    decl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    movl    <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>, <span class=\"token operator\">-</span><span class=\"token number\">20</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>)\n    movl    <span class=\"token operator\">-</span><span class=\"token number\">20</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    cmpl    <span class=\"token operator\">$</span><span class=\"token operator\">-</span><span class=\"token number\">1</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    jne    .L16\n    movl    <span class=\"token number\">$0</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">eax</span>\n    addl    <span class=\"token number\">$52</span>, <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>\n    popl    <span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>\n    popl    <span class=\"token operator\">%</span><span class=\"token register variable\">ebp</span>\n    leal    <span class=\"token operator\">-</span><span class=\"token number\">4</span>(<span class=\"token operator\">%</span><span class=\"token register variable\">ecx</span>), <span class=\"token operator\">%</span><span class=\"token register variable\">esp</span>\n    ret\n    .size    main, .<span class=\"token operator\">-</span>main\n    .comm    mk,<span class=\"token number\">5000004</span>,<span class=\"token number\">32</span>\n    .comm    prime,<span class=\"token number\">1400000</span>,<span class=\"token number\">32</span>\n    .comm    pnum,<span class=\"token number\">4</span>,<span class=\"token number\">4</span>\n    .comm    c,<span class=\"token number\">128</span>,<span class=\"token number\">32</span>\n    .ident    <span class=\"token string\">\"GCC: (GNU) 4.1.2 20061115 (prerelease) (Debian 4.1.1-21)\"</span>\n    .section    .note.GNU<span class=\"token operator\">-</span>stack,<span class=\"token string\">\"\"</span>,@progbits</code></pre></div>\n<p>The difference part is the assembly code:</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\"><span class=\"token coord\">--- prog_purec.s</span>\n<span class=\"token coord\">+++ prog_asm.s</span>\n<span class=\"token coord\">@@ -1,4 +1,4 @@</span>\n<span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>.file    \"prog_purec.c\"\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>.file    \"prog_asm.c\"\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>.text\n<span class=\"token prefix unchanged\"> </span>.globl init\n<span class=\"token prefix unchanged\"> </span>.type    init, @function\n</span><span class=\"token coord\">@@ -108,16 +108,9 @@</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>    movl    $0, -12(%ebp)\n<span class=\"token prefix unchanged\"> </span>    jmp    .L24\n<span class=\"token prefix unchanged\"> </span>.L25:\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>    movl    -24(%ebp), %edx\n<span class=\"token prefix deleted\">-</span>    movl    -16(%ebp), %eax\n<span class=\"token prefix deleted\">-</span>    movl    prime(,%eax,4), %eax\n<span class=\"token prefix deleted\">-</span>    movl    %eax, -40(%ebp)\n<span class=\"token prefix deleted\">-</span>    movl    %edx, %eax\n<span class=\"token prefix deleted\">-</span>    cltd\n<span class=\"token prefix deleted\">-</span>    idivl    -40(%ebp)\n<span class=\"token prefix deleted\">-</span>    movl    %eax, -40(%ebp)\n<span class=\"token prefix deleted\">-</span>    movl    -40(%ebp), %eax\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>#APP\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>    movl    %eax, -24(%ebp)\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>#NO_APP\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>    incl    -12(%ebp)\n<span class=\"token prefix unchanged\"> </span>.L24:\n<span class=\"token prefix unchanged\"> </span>    movl    -24(%ebp), %edx\n<span class=\"token prefix unchanged\"> </span>    movl    -16(%ebp), %eax\n<span class=\"token prefix unchanged\"> </span>    movl    prime(,%eax,4), %eax\n<span class=\"token prefix unchanged\"> </span>    movl    %eax, -40(%ebp)\n<span class=\"token prefix unchanged\"> </span>    movl    %edx, %eax\n<span class=\"token prefix unchanged\"> </span>    cltd\n<span class=\"token prefix unchanged\"> </span>    idivl    -40(%ebp)\n<span class=\"token prefix unchanged\"> </span>    movl    %edx, %eax\n<span class=\"token prefix unchanged\"> </span>    testl    %eax, %eax\n<span class=\"token prefix unchanged\"> </span>    je    .L25</span></code></pre></div>\n<p>At first glance, the optimization seems to be successful. In the generated assembly, the code is reduced from more than 10 lines to 2 lines, and an integer division is omitted. But actually, the calculation result was wrong. Why a performance tuning could lead to a wrong result? I was confused. After a long time of debugging, I finally found the reason.</p>\n<p>The root cause is that the compiler has generated codeÂ <code class=\"language-text\">movl %edx, %eax</code>Â to test whether the reminder is 0 after executing the divisionÂ <code class=\"language-text\">idivl -40(%ebp)</code>, this operation has overwritten the value ofÂ <code class=\"language-text\">%eax</code>Â which is the quotient of the division. So, how do we handle this optimization correctly?</p>\n<p>After thinking carefully, we could avoid the damn move action mentioned above, the quotient can be correctly retained. The correct code optimization is as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// prog_correct.c</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n\n<span class=\"token comment\">// Define the problem scale</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXN</span> <span class=\"token expression\"><span class=\"token number\">5000004</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXP</span> <span class=\"token expression\"><span class=\"token number\">350000</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXR</span> <span class=\"token expression\"><span class=\"token number\">2236</span></span></span>\n\n<span class=\"token keyword\">char</span> mk<span class=\"token punctuation\">[</span>MAXN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// Prime bits</span>\n<span class=\"token keyword\">int</span> prime<span class=\"token punctuation\">[</span>MAXP<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> pnum<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Primes</span>\n<span class=\"token keyword\">int</span> c<span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>             <span class=\"token comment\">// Array for generating answer</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">32</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        c<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> MAXN<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mk<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            prime<span class=\"token punctuation\">[</span>pnum<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> MAXR<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> i<span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> MAXN<span class=\"token punctuation\">;</span> j <span class=\"token operator\">+=</span> i<span class=\"token punctuation\">)</span>\n                    mk<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">,</span> ncase<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ncase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ncase<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        res <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> pnum<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mk<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n                    res <span class=\"token operator\">*=</span> c<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">else</span>\n            <span class=\"token punctuation\">{</span>\n                j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token string\">\"jmp    JDG\\n\"</span>\n                    <span class=\"token string\">\"WIL:\\n\"</span>\n                    <span class=\"token string\">\"movl    %eax, -24(%ebp)\\n\"</span>\n                    <span class=\"token string\">\"incl    -12(%ebp)\\n\"</span>\n                    <span class=\"token string\">\"JDG:\\n\"</span>\n                    <span class=\"token string\">\"movl    -24(%ebp), %edx\\n\"</span>\n                    <span class=\"token string\">\"movl    -16(%ebp), %eax\\n\"</span>\n                    <span class=\"token string\">\"movl    prime(,%eax,4), %eax\\n\"</span>\n                    <span class=\"token string\">\"movl    %eax, -40(%ebp)\\n\"</span>\n                    <span class=\"token string\">\"movl    %edx, %eax\\n\"</span>\n                    <span class=\"token string\">\"cltd\\n\"</span>\n                    <span class=\"token string\">\"idivl    -40(%ebp)\\n\"</span>\n                    <span class=\"token string\">\"testl    %edx, %edx\\n\"</span>\n                    <span class=\"token string\">\"je     WIL\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n                    res <span class=\"token operator\">*=</span> c<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\\n\"</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>or in intel style</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// prog_correct_intel.c</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n\n<span class=\"token comment\">// Define the problem scale</span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXN</span> <span class=\"token expression\"><span class=\"token number\">5000004</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXP</span> <span class=\"token expression\"><span class=\"token number\">350000</span></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MAXR</span> <span class=\"token expression\"><span class=\"token number\">2236</span></span></span>\n\n<span class=\"token keyword\">char</span> mk<span class=\"token punctuation\">[</span>MAXN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// Prime bits</span>\n<span class=\"token keyword\">int</span> prime<span class=\"token punctuation\">[</span>MAXP<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> pnum<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Primes</span>\n<span class=\"token keyword\">int</span> c<span class=\"token punctuation\">[</span><span class=\"token number\">32</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>             <span class=\"token comment\">// Array for generating answer</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">32</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        c<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> MAXN<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mk<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            prime<span class=\"token punctuation\">[</span>pnum<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> MAXR<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">=</span> i <span class=\"token operator\">*</span> i<span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> MAXN<span class=\"token punctuation\">;</span> j <span class=\"token operator\">+=</span> i<span class=\"token punctuation\">)</span>\n                    mk<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">,</span> j<span class=\"token punctuation\">,</span> ncase<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ncase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>ncase<span class=\"token operator\">--</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">scanf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        res <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> pnum<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mk<span class=\"token punctuation\">[</span>n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>n <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n                    res <span class=\"token operator\">*=</span> c<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">else</span>\n            <span class=\"token punctuation\">{</span>\n                j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n                __asm <span class=\"token punctuation\">{</span>\n                UL1<span class=\"token operator\">:</span>\n                    mov ecx<span class=\"token punctuation\">,</span> i\n                    mov eax<span class=\"token punctuation\">,</span> n\n                    cdq\n                    idiv prime<span class=\"token punctuation\">[</span>ecx<span class=\"token operator\">*</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span>\n                    test edx<span class=\"token punctuation\">,</span> edx\n                    jne UL2\n                    mov n<span class=\"token punctuation\">,</span> eax\n                    inc j\n                    jmp UL1\n                UL2<span class=\"token operator\">:</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> res <span class=\"token operator\">*=</span> c<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d\\n\"</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","fields":{"slug":"/posts/2008-11-08---A-Weird-Bug-Caused-by-Optimizing-Integer-Division-with-Assembly//posts/a-weird-bug-caused-by-optimizing-integer-division-with-assembly","tagSlugs":["/tag/programming/","/tag/assembly/"]},"frontmatter":{"date":"2008-11-08T00:40:00.000Z","description":"it's not easy to optimize code with assembly, especially when you are not familiar with how the compiler works.","tags":["Programming","Assembly"],"title":"A Weird Bug Caused by Optimizing Integer Division with Assembly","socialImage":{"publicURL":"/static/9e7467366f8cd66a9571f31a5421eb36/weird-assembly.jpg"}}}},"pageContext":{"slug":"/posts/2008-11-08---A-Weird-Bug-Caused-by-Optimizing-Integer-Division-with-Assembly//posts/a-weird-bug-caused-by-optimizing-integer-division-with-assembly"}},"staticQueryHashes":["251939775","288581551","401334301"],"slicesMap":{}}